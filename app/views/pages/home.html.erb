<% content_for :page_class, "berthier-home" %>

<!-- Flash messages -->
<% if flash[:notice] %>
  <div class="flash flash--notice"><%= flash[:notice] %></div>
<% end %>
<% if flash[:alert] %>
  <div class="flash flash--alert"><%= flash[:alert] %></div>
<% end %>

<!-- Header / Navigation -->
<header class="main-header">
  <div class="container">
    <nav class="main-nav">
      <div class="brand">
        <%= link_to root_path, class: "brand__link" do %>
          <span class="brand__name">LA CRAVATE DE BERTHIER</span>
          <span class="brand__tagline">L'√©l√©gance administrative depuis 1994</span>
        <% end %>
      </div>
      <ul class="main-nav__links">
        <li><a href="#valeurs">Nos valeurs</a></li>
        <li><%= link_to "Catalogue", cravates_path %></li>
        <li><a href="#manifeste">Le manifeste</a></li>
      </ul>
      <button class="mobile-menu-toggle" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </nav>
  </div>
</header>

<main class="berthier-home">
  <!-- Hero Section avec s√©lecteur de cravates -->
  <section class="hero">
    <div class="hero__grid">
      <div class="hero__copy">
        <h1 class="hero__title"><%= @hero[:title].html_safe %></h1>
        <p class="hero__subtitle"><%= @hero[:subtitle] %></p>
        <div class="hero__cta">
          <%= link_to @hero[:cta_text], cravates_path, class: "btn btn--large" %>
        </div>
      </div>
      <div class="hero__img-container">
        <!-- Image principale de Berthier - cliquable -->
        <div class="hero__berthier-showcase" id="berthierShowcase">
          <% @hero_cravates.each_with_index do |cravate, index| %>
            <%= image_tag cravate[:image],
                alt: "Berthier porte #{cravate[:name]}",
                class: "hero__berthier-img #{index == 0 ? 'active' : ''}",
                data: { cravate_index: index } %>
          <% end %>

          <!-- Message avec guillemets -->
          <div class="hero__click-message" id="clickMessage">
            <span>üëî ¬´ Un clic, une cravate, un crack ¬ª</span>
          </div>
        </div>

        <!-- S√©lecteur de cravates - pastilles -->
        <div class="hero__cravate-selector">
          <span class="selector__label">17 cravates disponibles</span>
          <div class="selector__options">
            <% @hero_cravates.each_with_index do |cravate, index| %>
              <button class="selector__dot <%= 'active' if index == 0 %>"
                      data-cravate-index="<%= index %>"
                      style="--swatch-color: <%= cravate[:swatch_color] %>"
                      title="<%= cravate[:name] %>">
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Piliers / Valeurs - Avec images -->
  <section id="valeurs" class="values-hero">
    <div class="container">
      <div class="values-hero__intro">
        <h2 class="values-hero__title">TROIS ENGAGEMENTS.<br>PAS DE COMPROMIS.</h2>
        <p class="values-hero__subtitle">La cravate qui assume ses convictions, m√™me si √ßa froisse quelques chemises.</p>
      </div>
      <div class="values-grid">
        <!-- Card √âcologique -->
        <article class="value-card value-card--1">
          <div class="value-card__image">
            <%= image_tag "bloc_solidaire/ficus.png", alt: "Plante de bureau fan√©e" %>
          </div>
          <div class="value-card__content">
            <div class="value-card__header">
              <span class="value-card__ref">[DOSSIER ECO-2026]</span>
            </div>
            <h3 class="value-card__title">√âCOLOGIQUE</h3>
            <p class="value-card__description">100% Lin bio sourc√© en France. Une mati√®re qui respire, contrairement √† votre carri√®re.</p>
            <div class="value-card__cta">
              <%= link_to "En savoir plus ‚Üí", engagement_ecologique_path, class: "value-card__link" %>
            </div>
          </div>
        </article>
        <!-- Card F√©ministe -->
        <article class="value-card value-card--2">
          <div class="value-card__image">
            <%= image_tag "bloc_solidaire/rouge_a_levre.png", alt: "Berthier avec rouge √† l√®vres" %>
          </div>
          <div class="value-card__content">
            <div class="value-card__header">
              <span class="value-card__ref">[DOSSIER FEM-1994]</span>
            </div>
            <h3 class="value-card__title">F√âMINISTE</h3>
            <p class="value-card__description">10% des b√©n√©fices revers√©s. Parce que le patriarcat de bureau est un concept d√©pass√©, m√™me pour Berthier.</p>
            <div class="value-card__cta">
              <%= link_to "En savoir plus ‚Üí", engagement_feministe_path, class: "value-card__link" %>
            </div>
          </div>
        </article>
        <!-- Card Solidaire -->
        <article class="value-card value-card--3">
          <div class="value-card__image">
            <%= image_tag "bloc_solidaire/pot-de-depart.png", alt: "Pot de d√©part Th√©r√®se" %>
          </div>
          <div class="value-card__content">
            <div class="value-card__header">
              <span class="value-card__ref">[DOSSIER ESS-FR]</span>
            </div>
            <h3 class="value-card__title">SOLIDAIRE</h3>
            <p class="value-card__description">Confectionn√©e par des entreprises de l'ESS. On soutient l'humain, le vrai, celui des ateliers.</p>
            <div class="value-card__cta">
              <%= link_to "En savoir plus ‚Üí", engagement_solidaire_path, class: "value-card__link" %>
            </div>
          </div>
        </article>
      </div>
      <div class="values-banner">
        <div class="values-banner__stat">
          <span class="values-banner__number">10%</span>
          <span class="values-banner__label">de nos b√©n√©fices revers√©s</span>
        </div>
        <div class="values-banner__stat">
          <span class="values-banner__number">100%</span>
          <span class="values-banner__label">Lin bio fran√ßais</span>
        </div>
        <div class="values-banner__stat">
          <span class="values-banner__number">ESS</span>
          <span class="values-banner__label">Ateliers solidaires</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Collection de produits -->
  <section id="produit" class="products">
    <div class="container">
      <h2 class="section-title">LE CATALOGUE ADMINISTRATIF</h2>
      <p class="section-subtitle">Dix-sept cravates. Pas une de plus. On ne fait pas dans l'exc√®s.</p>

      <div class="products__grid">
        <% @cravates.each do |cravate| %>
          <%= link_to cravate_path(cravate), class: "product-card" do %>
            <div class="product-card__badge">
              <%= cravate.material %>
            </div>
            <div class="product-card__img">
              <% if cravate.photos.attached? %>
                <%= image_tag cravate.photos.first, alt: cravate.name %>
              <% else %>
                <div class="product-img-placeholder">
                  [IMAGE <%= cravate.reference %>]
                </div>
              <% end %>
            </div>
            <div class="product-card__content">
              <span class="product-card__ref"><%= cravate.reference %></span>
              <h3 class="product-card__name"><%= cravate.name %></h3>
              <p class="product-card__description"><%= truncate(cravate.description, length: 100) %></p>
              <div class="product-card__footer">
                <span class="product-card__price"><%= number_to_currency(cravate.price, unit: "‚Ç¨", format: "%n%u") %></span>
                <% if cravate.available? %>
                  <span class="btn btn--small">Commander</span>
                <% else %>
                  <span class="product-card__stock">Rupture de stock</span>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </section>

  <!-- Bio Berthier -->
  <section id="manifeste" class="bio">
    <div class="container">
      <div class="bio__content">
        <h2 class="section-title"><%= @bio[:title] %></h2>
        <blockquote class="bio__quote">
          "<%= @bio[:quote] %>"
        </blockquote>
        <p class="bio__text"><%= @bio[:content] %></p>
        <p class="bio__signature"><%= @bio[:signature] %></p>
      </div>
    </div>
  </section>

  <!-- Newsletter -->
  <section id="newsletter" class="newsletter">
    <div class="container">
      <div class="newsletter__box">
        <h2><%= @newsletter[:title] %></h2>
        <p><%= @newsletter[:description] %></p>
        <%= form_with url: subscribe_newsletter_path, method: :post, local: true, class: "newsletter__form" do |form| %>
          <%= form.email_field :email,
              placeholder: @newsletter[:placeholder],
              required: true,
              class: "newsletter__input" %>
          <%= form.submit @newsletter[:button], class: "btn" %>
        <% end %>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer__content">
        <div class="footer__brand">
          <strong>LA CRAVATE DE BERTHIER</strong>
          <p class="footer__tagline">L'√©l√©gance de la d√©construction</p>
        </div>
        <nav class="footer__nav">
          <% @footer[:links].each do |link| %>
            <%= link_to link[:text], link[:url], class: "footer__link" %>
          <% end %>
        </nav>
        <p class="footer__legal">
          ¬© <%= @footer[:year] %> <%= @footer[:company] %> | <%= @footer[:legal] %>
        </p>
      </div>
    </div>
  </footer>
</main>

<script>
// Menu mobile toggle
document.querySelector('.mobile-menu-toggle')?.addEventListener('click', function() {
  document.querySelector('.main-nav__links').classList.toggle('active');
  this.classList.toggle('active');
});

// S√©lecteur de cravates avec auto-d√©filement initial
document.addEventListener('DOMContentLoaded', function() {
  const images = document.querySelectorAll('.hero__berthier-img');
  const dots = document.querySelectorAll('.selector__dot');
  const showcase = document.getElementById('berthierShowcase');
  const clickMessage = document.getElementById('clickMessage');
  let currentIndex = 0;
  let autoPlayInterval = null;
  let autoPlayCount = 0;
  let userHasInteracted = false;

  function switchCravate(index) {
    images.forEach(img => img.classList.remove('active'));
    dots.forEach(dot => dot.classList.remove('active'));

    images[index].classList.add('active');
    dots[index].classList.add('active');

    currentIndex = index;
  }

  function stopAutoPlay() {
    if (autoPlayInterval) {
      clearInterval(autoPlayInterval);
      autoPlayInterval = null;
    }
  }

  function hideMessage() {
    if (clickMessage) {
      clickMessage.classList.add('hidden');
    }
  }

  function startAutoPlay() {
    autoPlayInterval = setInterval(() => {
      autoPlayCount++;
      const nextIndex = (currentIndex + 1) % images.length;
      switchCravate(nextIndex);

      // Arr√™ter apr√®s 4 changements
      if (autoPlayCount >= 4) {
        stopAutoPlay();
      }
    }, 1000);
  }

  // Clic sur les pastilles
  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      userHasInteracted = true;
      stopAutoPlay();
      hideMessage();
      switchCravate(index);
    });
  });

  // Clic sur l'image pour passer √† la suivante
  showcase?.addEventListener('click', function() {
    userHasInteracted = true;
    stopAutoPlay();
    hideMessage();
    const nextIndex = (currentIndex + 1) % images.length;
    switchCravate(nextIndex);
  });

  // Arr√™ter l'auto-play si l'utilisateur survole l'image
  showcase?.addEventListener('mouseenter', () => {
    if (!userHasInteracted) {
      stopAutoPlay();
    }
  });

  // Reprendre l'auto-play si l'utilisateur quitte l'image (si pas encore interagi)
  showcase?.addEventListener('mouseleave', () => {
    if (!userHasInteracted && autoPlayCount < 4) {
      startAutoPlay();
    }
  });

  // D√©marrer l'auto-d√©filement apr√®s un court d√©lai
  setTimeout(() => {
    if (!userHasInteracted) {
      startAutoPlay();
    }
  }, 800);
});
</script>
